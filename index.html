<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>計算ドリルパーフェクトマスター（PWA v61）</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ff87b7">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
<style>
  :root { --accent:#ff87b7; --accent2:#8ad7ff; --text:#333 }
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;background:linear-gradient(180deg,#fff5fb,#f5fbff)}
  header{position:sticky;top:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:12px 16px;font-weight:700;text-align:center}
  .wrap{max-width:560px;margin:0 auto;padding:12px 12px 80px}
  .title{font-size:20px;font-weight:800;margin:10px 0 6px}
  .small{font-size:12px;color:#6b7280}
  .card{background:#fff;border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 6px 16px rgba(0,0,0,.07)}
  .row{display:flex;gap:10px}
  .col{flex:1}
  input,select,textarea{width:100%;padding:12px;border-radius:12px;border:2px solid #e5e7eb;font-size:16px}
  .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn.main{background:var(--accent);color:#fff}
  .btn.sub{background:var(--accent2);color:#fff}
  .btn.ghost{background:#fff;border:2px solid var(--accent);color:var(--accent)}
  .grid{display:grid;gap:6px}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .calHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .calHeader .month{font-weight:800}
  .day{background:#fff;border:2px solid #f3f4f6;border-radius:10px;padding:8px;text-align:center;cursor:pointer}
  .day.sel{outline:3px solid #ffd1e5}
  .day.good{background:#ecfeff;border-color:#bae6fd}
  .day.great{background:#fff1f5;border-color:#fbcfe8}
  .sticker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .sticker{border:2px solid #e5e7eb;border-radius:12px;padding:8px;text-align:center;cursor:pointer}
  .sticker.sel{border-color:var(--accent);box-shadow:0 0 0 3px #ffd1e5}
  .palette{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .stamp{border:2px solid #e5e7eb;border-radius:10px;padding:8px;text-align:center;cursor:pointer;background:#fff;font-size:22px;user-select:none}
  .stamp.sel{border-color:var(--accent);box-shadow:0 0 0 3px #ffd1e5}
  .board60{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
  .cell60{background:#fff;border:2px solid #e5e7eb;border-radius:10px;height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;cursor:pointer}
  .cell60 .lbl{font-size:11px;color:#6b7280;margin-top:2px}
  .cell60 .val{font-size:24px;line-height:1}
  .cell60.filled{background:#eef2ff;border-color:#c7d2fe}
  .topTabs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:8px}
  .topTabs button{border:none;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 0;cursor:pointer}
  .topTabs button.active{background:#ffe4f1;border-color:#ffd1e5}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:#111827;color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;opacity:0;transition:.3s;pointer-events:none}
  .toast.show{opacity:1}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{background:#fff;border-radius:14px;max-width:520px;width:100%;padding:16px;box-shadow:0 20px 40px rgba(0,0,0,.2)}
  .modal .box h3{margin:0 0 8px}
  .modal.show{display:flex}
</style>
</head>
<body>
<header>計算ドリルパーフェクトマスター</header>

<div class="wrap">
  <div class="topTabs">
    <button id="tab-record" class="active" onclick="showPage('record')">記録</button>
    <button id="tab-calendar" onclick="showPage('calendar')">カレンダー</button>
    <button id="tab-stamp" onclick="showPage('stamp')">スタンプ表</button>
  </div>

  <!-- Record Page -->
  <section id="page-record">
    <div class="card">
      <div class="title">きろくする日</div>
      <div class="row">
        <input id="datePick" type="date" class="col">
        <button class="btn ghost" onclick="setToday()">今日</button>
      </div>
      <div class="small">※ カレンダーのマスをタップして日付をえらぶこともできます</div>
    </div>

    <div class="card">
      <div class="title">きょうのドリル</div>
      <div class="row">
        <div class="col">
          <div class="small">やったページ</div>
          <input id="pages" type="text" placeholder="例：p.12〜15">
        </div>
        <div class="col">
          <div class="small">かかった時間</div>
          <select id="minutes">
            <option value="">えらんでね</option>
            <option>5分</option><option>10分</option><option>15分</option><option>20分</option>
            <option>25分</option><option>30分</option><option>45分</option><option>60分</option>
          </select>
        </div>
      </div>
      <div class="small" style="margin-top:8px">ひとことメモ</div>
      <textarea id="note" rows="3" placeholder="例：ひきざんがすこしむずかしかった…"></textarea>
      <div style="height:10px"></div>
      <button class="btn main" onclick="saveRecord()">きろくする</button>
    </div>

    <div class="card">
      <div class="title">ふりかえりシール</div>
      <div id="stickers" class="sticker-grid"></div>
    </div>
  </section>

  <!-- Calendar Page -->
  <section id="page-calendar" class="hidden">
    <div class="card">
      <div class="calHeader">
        <button class="btn ghost" onclick="shiftMonth(-1)">← 前の月</button>
        <div class="month" id="monthLabel"></div>
        <button class="btn ghost" onclick="shiftMonth(1)">次の月 →</button>
      </div>
      <div id="calendar" class="calendar"></div>
      <div class="small" style="margin-top:6px">※ 記録のある日をタップすると詳細を表示します</div>
    </div>
  </section>

  <!-- Stamp Page -->
  <section id="page-stamp" class="hidden">
    <div class="card">
      <div class="title">スタンプ表（第1回〜第60回）</div>
      <div class="small">スタンプ：<span id="cur">🌟</span>（空マスはタップで貼る／貼ってあるマスはタップで消す確認）</div>
      <div id="palette" class="palette"></div>
      <div style="height:8px"></div>
      <div id="board60" class="board60"></div>
      <div class="row" style="margin-top:10px;gap:10px">
        <button class="btn sub" onclick="clearBoard()">ぜんぶけす</button>
        <button class="btn ghost" onclick="exportJSON()">JSON書き出し</button>
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast">OK!</div>

<!-- modal -->
<div class="modal" id="modal">
  <div class="box">
    <h3 id="mTitle">記録</h3>
    <div id="mBody"></div>
    <div style="text-align:right;margin-top:10px">
      <button class="btn ghost" onclick="closeModal()">とじる</button>
    </div>
  </div>
</div>

<script>
  // SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));
  }

  // State
  const STICKER_LIST = ['💪 がんばった！','🌈 すごくできた！','🔥 あと少し！','⚡ はやくできた！'];
  const STAMPS = ['🌟','💮','👏','💪','🌈','🧠','🐻','🐰','🐱','🍀','🍎','🎵','⚡','🔥','🥇'];
  const LABELS60 = Array.from({length:60}, (_,i)=>`第${i+1}回`);

  let state = JSON.parse(localStorage.getItem('pm_v61_state') || '{}');
  if (!state.records) state.records = {}; // yyyy-mm-dd -> {pages, minutes, note, sticker}
  if (!state.board60) state.board60 = Array(60).fill('');
  if (!state.current) state.current = '🌟';
  if (!state.selectedDate) state.selectedDate = fmt(new Date());
  if (!state.viewMonth) state.viewMonth = state.selectedDate.slice(0,7); // yyyy-mm

  // Helpers
  const toast = document.getElementById('toast');
  const calendarEl = document.getElementById('calendar');
  const monthLabel = document.getElementById('monthLabel');
  const stickersEl = document.getElementById('stickers');
  const boardEl = document.getElementById('board60');
  const paletteEl = document.getElementById('palette');
  const curEl = document.getElementById('cur');
  const datePick = document.getElementById('datePick');
  const modal = document.getElementById('modal');
  const mTitle = document.getElementById('mTitle');
  const mBody = document.getElementById('mBody');

  function save(){ localStorage.setItem('pm_v61_state', JSON.stringify(state)); }
  function fmt(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}`; }
  function showToast(m){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); }
  function setToday(){ const t = fmt(new Date()); state.selectedDate = t; datePick.value = t; state.viewMonth = t.slice(0,7); save(); renderCalendar(); showToast('今日にしたよ'); }
  window.setToday = setToday;

  // Tabs
  function showPage(which){
    document.getElementById('page-record').classList.add('hidden');
    document.getElementById('page-calendar').classList.add('hidden');
    document.getElementById('page-stamp').classList.add('hidden');
    document.getElementById('tab-record').classList.remove('active');
    document.getElementById('tab-calendar').classList.remove('active');
    document.getElementById('tab-stamp').classList.remove('active');
    if (which==='record'){ document.getElementById('page-record').classList.remove('hidden'); document.getElementById('tab-record').classList.add('active'); }
    if (which==='calendar'){ document.getElementById('page-calendar').classList.remove('hidden'); document.getElementById('tab-calendar').classList.add('active'); renderCalendar(); }
    if (which==='stamp'){ document.getElementById('page-stamp').classList.remove('hidden'); document.getElementById('tab-stamp').classList.add('active'); renderPalette(); renderBoard60(); }
  }

  // Stickers
  function renderStickers(){
    stickersEl.innerHTML='';
    STICKER_LIST.forEach(s=>{
      const [emoji,label]=s.split(' ');
      const d=document.createElement('div'); d.className='sticker'; d.innerHTML=`<div style="font-size:20px">${emoji}</div><div class="small">${label}</div>`;
      d.onclick=()=>{ document.querySelectorAll('.sticker').forEach(x=>x.classList.remove('sel')); d.classList.add('sel'); d.dataset.value = label; };
      stickersEl.appendChild(d);
    });
  }

  // Calendar with month nav and details
  function ymToDateStr(ym){ const [y,m]=ym.split('-'); return `${y}-${m}-01`; }
  function shiftMonth(delta){
    const [y,m] = state.viewMonth.split('-').map(n=>parseInt(n));
    const d = new Date(y, m-1 + delta, 1);
    const ym = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
    state.viewMonth = ym;
    save();
    renderCalendar();
  }
  function renderCalendar(){
    const ym = state.viewMonth;
    monthLabel.textContent = ym.replace('-', '年') + '月';
    calendarEl.innerHTML = '';
    const [y,m] = ym.split('-').map(n=>parseInt(n));
    const first = new Date(y,m-1,1);
    const startDay = first.getDay();
    const days = new Date(y, m, 0).getDate();

    ['日','月','火','水','木','金','土'].forEach(w=>{
      const wd = document.createElement('div'); wd.textContent = w; wd.className='small'; calendarEl.appendChild(wd);
    });

    for(let i=0;i<startDay;i++){ const b=document.createElement('div'); b.className='day'; b.style.visibility='hidden'; calendarEl.appendChild(b); }
    for(let d=1; d<=days; d++){
      const box = document.createElement('div'); box.className='day';
      const key = `${y}-${('0'+m).slice(-2)}-${('0'+d).slice(-2)}`;
      const rec = state.records[key];
      if (rec) { if (rec.sticker==='すごくできた！') box.classList.add('great'); else box.classList.add('good'); }
      if (key===state.selectedDate) box.classList.add('sel');
      box.innerHTML = `<div>${d}</div><div class="small">${rec? (rec.minutes||''):''}</div>`;
      box.onclick = ()=>{
        state.selectedDate = key; save(); datePick.value = key; renderCalendar();
        if (rec){ openModal(key, rec); }
        else { showToast(`${key} をえらんだよ`); }
      };
      calendarEl.appendChild(box);
    }
  }

  function openModal(date, rec){
    mTitle.textContent = `${date} の記録`;
    mBody.innerHTML = `
      <div class="small">ページ：${rec.pages||'-'}</div>
      <div class="small">時間：${rec.minutes||'-'}</div>
      <div class="small">シール：${rec.sticker||'-'}</div>
      <div class="small">メモ：</div>
      <div style="white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-top:4px">${(rec.note||'').replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</div>`;
    modal.classList.add('show');
  }
  function closeModal(){ modal.classList.remove('show'); }
  window.closeModal = closeModal;

  // Record save
  function saveRecord(){
    const pages = document.getElementById('pages').value.trim();
    const minutes = document.getElementById('minutes').value;
    const note = document.getElementById('note').value.trim();
    const selSticker = document.querySelector('.sticker.sel');
    const sticker = selSticker ? selSticker.querySelector('.small').textContent : '';
    const key = datePick.value || state.selectedDate || fmt(new Date());
    if (!key){ showToast('日付をえらんでね'); return; }
    if (!pages && !minutes && !sticker && !note){ showToast('入力してね！'); return; }
    state.records[key] = {pages, minutes, note, sticker};
    save();
    showToast(`${key} にきろくしたよ！`);
    document.getElementById('pages').value='';
    document.getElementById('minutes').value='';
    document.getElementById('note').value='';
    document.querySelectorAll('.sticker').forEach(x=>x.classList.remove('sel'));
    renderCalendar();
  }
  window.saveRecord = saveRecord;

  // Stamp board 60 with tap-to-erase
  function renderPalette(){
    paletteEl.innerHTML='';
    STAMPS.forEach(s=>{
      const d=document.createElement('div'); d.className='stamp'+(state.current===s?' sel':''); d.textContent=s;
      d.onclick=()=>{ state.current=s; curEl.textContent=s; save(); renderPalette(); };
      paletteEl.appendChild(d);
    });
  }
  function renderBoard60(){
    boardEl.innerHTML='';
    for(let i=0;i<60;i++){
      const c=document.createElement('div'); c.className='cell60';
      const val = state.board60[i] || '';
      c.innerHTML = `<div class="val">${val}</div><div class="lbl">第${i+1}回</div>`;
      if (val) c.classList.add('filled');
      c.onclick = ()=> toggleStamp(i);
      boardEl.appendChild(c);
    }
  }
  function toggleStamp(i){
    const has = !!state.board60[i];
    if (!has){
      state.board60[i]=state.current;
      save();
      const el=boardEl.children[i]; el.querySelector('.val').textContent=state.current; el.classList.add('filled');
    } else {
      if(confirm('このスタンプを消しますか？')){
        state.board60[i]=''; save();
        const el=boardEl.children[i]; el.querySelector('.val').textContent=''; el.classList.remove('filled');
      }
    }
  }
  function clearBoard(){ if(!confirm('ぜんぶ けしますか？')) return; state.board60 = Array(60).fill(''); save(); renderBoard60(); }
  function exportJSON(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pm_v61_data.json'; a.click(); }
  window.clearBoard = clearBoard; window.exportJSON = exportJSON;

  // Init
  datePick.value = state.selectedDate;
  renderStickers();
  renderCalendar();
  renderPalette();
  renderBoard60();
  showPage('record');
</script>
</body>
</html>
